import './polyfills.server.mjs';
import{j as g}from"./chunk-XUP2CPZI.mjs";import{a as h}from"./chunk-2MWTOOCD.mjs";import{Lc as c,O as a,Pc as u,S as s,ga as o,n,qa as l}from"./chunk-6VKWEFB2.mjs";var d=class i{constructor(t,r,e){this.http=t;this.router=r;this.platformId=e;this.isBrowser=c(this.platformId),this.isBrowser&&this.checkAuth()}apiUrl=`${h.apiUrl}/auth`;isBrowser;TOKEN_KEY="auth_token";USER_KEY="current_user";currentUser=o(null);isAuthenticated=o(!1);token=o(null);error=o(null);loading=o(!1);checkAuth(){if(this.isBrowser)try{let t=localStorage.getItem(this.TOKEN_KEY),r=localStorage.getItem(this.USER_KEY);if(console.log("\u{1F50D} AuthService checkAuth:",{hasToken:!!t,hasUser:!!r}),t&&r){let e=JSON.parse(r);this.token.set(t),this.currentUser.set(e),this.isAuthenticated.set(!0),console.log("\u2705 Auth state restored:",e.username),console.log("\u{1F510} Token (first 30 chars):",t.substring(0,30)+"...")}else console.log("\u274C No auth data in localStorage")}catch(t){console.error("\u274C Failed to restore auth state:",t),this.clearAuth()}}syncAuthState(){if(this.isBrowser)try{let t=localStorage.getItem(this.TOKEN_KEY),r=localStorage.getItem(this.USER_KEY);if(t&&r){let e=JSON.parse(r);this.token.set(t),this.currentUser.set(e),this.isAuthenticated.set(!0),console.log("\u{1F504} Auth state synced")}}catch(t){console.error("Failed to sync auth state:",t),this.clearAuth()}}async login(t,r){try{this.loading.set(!0),this.error.set(null),console.log("\u{1F511} Attempting login for:",t);let e=await n(this.http.post(`${this.apiUrl}/login`,{username:t,password:r}));return e.success&&e.data&&(this.isBrowser&&(localStorage.setItem(this.TOKEN_KEY,e.data.token),localStorage.setItem(this.USER_KEY,JSON.stringify(e.data.user)),console.log("\u{1F4BE} Saved to localStorage:"),console.log("   - "+this.TOKEN_KEY+": "+e.data.token.substring(0,30)+"..."),console.log("   - "+this.USER_KEY+": "+e.data.user.username)),this.token.set(e.data.token),this.currentUser.set(e.data.user),this.isAuthenticated.set(!0),console.log("\u2705 Login successful:",e.data.user.username)),this.loading.set(!1),e}catch(e){throw this.loading.set(!1),this.error.set(e.error?.message||"Login failed"),console.error("\u274C Login failed:",e),e}}logout(){console.log("\u{1F6AA} Logging out"),this.clearAuth(),this.router.navigate(["/"]),console.log("\u{1F44B} Logged out successfully")}clearAuth(){this.isBrowser&&(localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY),console.log("\u{1F5D1}\uFE0F Cleared localStorage auth data")),this.token.set(null),this.currentUser.set(null),this.isAuthenticated.set(!1)}getToken(){let t=this.token();return console.log("\u{1F511} getToken() called:",t?"Token found":"No token"),t}getUser(){return this.currentUser()}isLoggedIn(){return this.isAuthenticated()}isBrowserPlatform(){return this.isBrowser}static \u0275fac=function(r){return new(r||i)(s(u),s(g),s(l))};static \u0275prov=a({token:i,factory:i.\u0275fac,providedIn:"root"})};export{d as a};
