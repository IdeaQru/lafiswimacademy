import './polyfills.server.mjs';
import{k as g}from"./chunk-ZQZ65V2P.mjs";import{a as h}from"./chunk-2MWTOOCD.mjs";import{Bd as u,U as l,Y as s,n,na as o,xd as c,za as a}from"./chunk-37477ZKR.mjs";var d=class i{constructor(t,r,e){this.http=t;this.router=r;this.platformId=e;this.isBrowser=c(this.platformId),this.isBrowser&&this.checkAuth()}apiUrl=`${h.apiUrl}/auth`;isBrowser;TOKEN_KEY="auth_token";USER_KEY="current_user";currentUser=o(null);isAuthenticated=o(!1);token=o(null);error=o(null);loading=o(!1);checkAuth(){if(this.isBrowser)try{let t=localStorage.getItem(this.TOKEN_KEY),r=localStorage.getItem(this.USER_KEY);if(console.log("\u{1F50D} AuthService.checkAuth()"),console.log("   Token:",t?"EXISTS":"NOT FOUND"),console.log("   User:",r?"EXISTS":"NOT FOUND"),t&&r){let e=JSON.parse(r);this.token.set(t),this.currentUser.set(e),this.isAuthenticated.set(!0),console.log("   \u2705 Auth restored:",e.username)}}catch(t){console.error("\u274C checkAuth error:",t),this.clearAuth()}}syncAuthState(){if(this.isBrowser){console.log("\u{1F504} AuthService.syncAuthState()");try{let t=localStorage.getItem(this.TOKEN_KEY),r=localStorage.getItem(this.USER_KEY);if(console.log("   Checking localStorage:"),console.log("   - Token:",t?"EXISTS":"NOT FOUND"),console.log("   - User:",r?"EXISTS":"NOT FOUND"),t&&r){let e=JSON.parse(r);this.token.set(t),this.currentUser.set(e),this.isAuthenticated.set(!0),console.log("   \u2705 Synced successfully")}else console.log("   \u26A0\uFE0F No token/user found"),this.clearAuth()}catch(t){console.error("\u274C syncAuthState error:",t),this.clearAuth()}}}async login(t,r){try{this.loading.set(!0),this.error.set(null),console.log("\u{1F511} AuthService.login()"),console.log("   Username:",t);let e=await n(this.http.post(`${this.apiUrl}/login`,{username:t,password:r}));return e.success&&e.data&&(this.isBrowser&&(localStorage.setItem(this.TOKEN_KEY,e.data.token),localStorage.setItem(this.USER_KEY,JSON.stringify(e.data.user)),console.log("   \u{1F4BE} Saved to localStorage:"),console.log(`      - ${this.TOKEN_KEY}: ${e.data.token.substring(0,20)}...`),console.log(`      - ${this.USER_KEY}: ${e.data.user.username}`)),this.token.set(e.data.token),this.currentUser.set(e.data.user),this.isAuthenticated.set(!0),console.log("\u2705 Login successful:",e.data.user.username)),this.loading.set(!1),e}catch(e){throw this.loading.set(!1),this.error.set(e.error?.message||"Login failed"),console.error("\u274C Login error:",e),e}}logout(){console.log("\u{1F6AA} AuthService.logout()"),this.clearAuth(),this.router.navigate(["/login"])}clearAuth(){this.isBrowser&&(localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY),console.log("   \u{1F5D1}\uFE0F Cleared localStorage")),this.token.set(null),this.currentUser.set(null),this.isAuthenticated.set(!1)}getToken(){return this.token()}getUser(){return this.currentUser()}isLoggedIn(){return this.isAuthenticated()}isBrowserPlatform(){return this.isBrowser}static \u0275fac=function(r){return new(r||i)(s(u),s(g),s(a))};static \u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"})};export{d as a};
